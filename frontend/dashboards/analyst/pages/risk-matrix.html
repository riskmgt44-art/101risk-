<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Matrix • RiskMGT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #5DA1A1;
            --primary-hover: #4e9393;
            --green: #10b981;
            --red: #ef4444;
            --amber: #f59e0b;
            --blue: #3b82f6;
            --neutral: #6b7280;
            --text-primary: #111111;
            --text-secondary: #555555;
            --text-muted: #888888;
            --bg: #FFFFFF;
            --card-bg: #FFFFFF;
            --border: #e8e8e8;
            --shadow-sm: 0 3.2px 9.6px rgba(0,0,0,0.06);
            --shadow-md: 0 9.6px 25.6px rgba(0,0,0,0.08);
            --shadow-lg: 0 16px 40px rgba(0,0,0,0.1);
            --radius: 12.8px;
            --transition: all 0.3s ease;
            
            /* Matrix colors */
            --matrix-critical: #d32f2f;
            --matrix-high: #f57c00;
            --matrix-medium: #fdd835;
            --matrix-low: #7cb342;
            --matrix-cell-bg: #f8f9fa;
            --matrix-highlight: #5DA1A1;
            --matrix-border: #dee2e6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
        }

        .top-nav {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .back-btn:hover {
            background: rgba(93,161,161,0.06);
            color: var(--primary);
        }
        
        .nav-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .risk-badge {
            background: rgba(93,161,161,0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 9.6px;
            background: transparent;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }
        
        .btn-icon:hover {
            background: rgba(93,161,161,0.06);
            color: var(--primary);
        }
        
        .btn-primary {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 9.6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-refresh {
            padding: 8px 16px;
            background: white;
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 9.6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .btn-refresh:hover {
            background: rgba(93,161,161,0.06);
            border-color: var(--primary-hover);
            color: var(--primary-hover);
        }
        
        .btn-refresh.refreshing i {
            animation: spin 1s linear infinite;
        }

        .main {
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 24px;
        }

        .matrix-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .risk-header-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .risk-info {
            flex: 1;
        }
        
        .risk-id {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .risk-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .risk-meta {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .risk-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .risk-meta-item i {
            color: var(--primary);
            width: 16px;
        }
        
        .last-updated {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .current-rating {
            background: rgba(93,161,161,0.05);
            padding: 16px 24px;
            border-radius: var(--radius);
            text-align: center;
            min-width: 200px;
        }
        
        .rating-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .rating-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .rating-category {
            font-size: 14px;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 999px;
            display: inline-block;
        }
        
        .category-critical { background: rgba(211, 47, 47, 0.1); color: var(--matrix-critical); }
        .category-high { background: rgba(245, 124, 0, 0.1); color: var(--matrix-high); }
        .category-medium { background: rgba(253, 216, 53, 0.1); color: #b8860b; }
        .category-low { background: rgba(124, 179, 66, 0.1); color: var(--matrix-low); }

        .matrix-grid-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        
        .matrix-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .matrix-title i {
            color: var(--primary);
        }
        
        .matrix-table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid var(--border);
            font-size: 14px;
            min-width: 600px;
        }
        
        .matrix-table th {
            background: #f1f3f4;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .matrix-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border);
            font-weight: 500;
        }
        
        .matrix-table td:first-child {
            background: #f1f3f4;
            font-weight: 600;
            color: var(--text-primary);
            text-align: left;
            padding-left: 16px;
        }
        
        .matrix-table tr:first-child th {
            background: #e9ecef;
        }
        
        .matrix-cell-critical {
            background-color: rgba(211, 47, 47, 0.2);
            color: #b71c1c;
            font-weight: 600;
        }
        
        .matrix-cell-high {
            background-color: rgba(245, 124, 0, 0.2);
            color: #e65100;
            font-weight: 600;
        }
        
        .matrix-cell-medium {
            background-color: rgba(253, 216, 53, 0.2);
            color: #b8860b;
            font-weight: 600;
        }
        
        .matrix-cell-low {
            background-color: rgba(124, 179, 66, 0.2);
            color: #33691e;
            font-weight: 600;
        }
        
        .matrix-cell-highlight {
            border: 3px solid var(--matrix-highlight) !important;
            box-shadow: 0 0 0 2px rgba(93,161,161,0.3);
            transform: scale(1.02);
            position: relative;
            z-index: 2;
        }
        
        .matrix-cell-highlight::after {
            content: '●';
            position: absolute;
            top: -8px;
            right: -8px;
            color: var(--matrix-highlight);
            font-size: 16px;
            text-shadow: 0 0 4px white;
        }

        .matrix-legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin: 24px 0 8px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .legend-color.critical { background: var(--matrix-critical); }
        .legend-color.high { background: var(--matrix-high); }
        .legend-color.medium { background: var(--matrix-medium); }
        .legend-color.low { background: var(--matrix-low); }

        .assessment-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            padding: 24px;
            border: 1px solid var(--border);
        }
        
        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .assessment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .assessment-item {
            background: rgba(93,161,161,0.02);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .assessment-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .assessment-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .assessment-sub {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .assessment-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
        }
        
        .badge-acceptable {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green);
        }
        
        .badge-unacceptable {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        .score-calculation {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .score-formula {
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        .score-formula strong {
            color: var(--primary);
            font-size: 18px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-source-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .data-source-badge.realtime {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green);
        }
        
        .data-source-badge.cached {
            background: rgba(245, 158, 11, 0.1);
            color: var(--amber);
        }
        
        .data-source-badge.api {
            background: rgba(93, 161, 161, 0.1);
            color: var(--primary);
        }

        .arrow {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
        }
        
        .arrow-high { border-bottom: 12px solid var(--red); }
        .arrow-medium { border-bottom: 12px solid var(--amber); }
        .arrow-low { border-bottom: 12px solid var(--green); }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error { border-left-color: var(--red); }
        .toast.success { border-left-color: var(--green); }
        .toast.warning { border-left-color: var(--amber); }

        @media (max-width: 768px) {
            .main { padding: 16px; }
            .top-nav { padding: 0 16px; }
            .matrix-table { font-size: 12px; }
            .matrix-table th, .matrix-table td { padding: 8px 4px; }
            .assessment-grid { grid-template-columns: 1fr; }
            .risk-header-card { flex-direction: column; align-items: flex-start; }
            .current-rating { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
            <button class="back-btn" onclick="closeWindow()">
                <i class="fas fa-times"></i>
                Close
            </button>
            <div class="nav-title">
                <i class="fas fa-th"></i>
                Risk Matrix
                <span class="risk-badge" id="riskIdBadge"></span>
            </div>
        </div>
        <div class="nav-actions">
            <button class="btn-refresh" onclick="refreshData()" id="refreshBtn">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <button class="btn-icon" onclick="printMatrix()" title="Print Matrix">
                <i class="fas fa-print"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="matrix-container">
            <!-- Risk Header -->
            <div class="risk-header-card">
                <div class="risk-info">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div class="risk-id" id="riskId">Loading...</div>
                        <span class="data-source-badge" id="dataSourceBadge">
                            <i class="fas fa-circle"></i>
                            Loading
                        </span>
                    </div>
                    <h1 class="risk-title" id="riskTitle">Loading risk data...</h1>
                    <div class="risk-meta">
                        <div class="risk-meta-item">
                            <i class="fas fa-user"></i>
                            <span id="riskOwner">—</span>
                        </div>
                        <div class="risk-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span id="lastReviewed">—</span>
                        </div>
                        <div class="risk-meta-item">
                            <i class="fas fa-tag"></i>
                            <span id="functionalArea">—</span>
                        </div>
                    </div>
                    <div class="last-updated" id="lastUpdated">
                        <i class="fas fa-clock"></i>
                        Last updated: <span id="updateTime">Just now</span>
                    </div>
                </div>
                <div class="current-rating">
                    <div class="rating-label">Current Rating</div>
                    <div class="rating-value" id="currentScore">—</div>
                    <div class="rating-category" id="currentCategory">—</div>
                    <div style="margin-top: 8px; font-size: 13px;" id="acceptabilityBadge"></div>
                </div>
            </div>

            <!-- 5x5 Matrix -->
            <div class="matrix-grid-section">
                <div class="matrix-title">
                    <i class="fas fa-border-all"></i>
                    5×5 Risk Matrix
                </div>
                
                <div class="matrix-table-wrapper">
                    <table class="matrix-table" id="riskMatrix">
                        <thead>
                            <tr>
                                <th>Severity →<br>Likelihood ↓</th>
                                <th>Catastrophic</th>
                                <th>Critical</th>
                                <th>Moderate</th>
                                <th>Marginal</th>
                                <th>Negligible</th>
                            </tr>
                        </thead>
                        <tbody id="matrixBody">
                            <!-- Matrix populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="matrix-legend">
                    <div class="legend-item">
                        <div class="legend-color critical"></div>
                        <span>Critical (15-25)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color high"></div>
                        <span>High (10-14)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color medium"></div>
                        <span>Medium (5-9)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color low"></div>
                        <span>Low (1-4)</span>
                    </div>
                </div>
            </div>

            <!-- Current Assessment Panel -->
            <div class="assessment-panel">
                <div class="panel-title">
                    <i class="fas fa-clipboard-check"></i>
                    Current Assessment
                </div>
                
                <div class="assessment-grid">
                    <div class="assessment-item">
                        <div class="assessment-label">Likelihood</div>
                        <div class="assessment-value" id="likelihoodValue">—</div>
                        <div class="assessment-sub" id="likelihoodDesc">—</div>
                    </div>
                    
                    <div class="assessment-item">
                        <div class="assessment-label">Severity/Impact</div>
                        <div class="assessment-value" id="impactValue">—</div>
                        <div class="assessment-sub" id="impactDesc">—</div>
                    </div>
                </div>
                
                <div class="score-calculation">
                    <div class="score-formula">
                        <span id="likelihoodNum">—</span> × <span id="impactNum">—</span> = 
                        <strong id="scoreCalculation">—</strong>
                    </div>
                    <div>
                        <span class="assessment-badge" id="acceptabilityBadgeLarge"></span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // API Configuration
        const API_BASE_URL = window.location.origin.includes('localhost') 
            ? 'http://localhost:8080/api' 
            : '/api';
        
        // Risk Matrix Data
        const riskMatrix = {
            likelihoodLevels: [
                { name: 'Frequent', value: 5 },
                { name: 'Probable', value: 4 },
                { name: 'Occasional', value: 3 },
                { name: 'Remote', value: 2 },
                { name: 'Improbable', value: 1 }
            ],
            
            severityLevels: [
                { name: 'Catastrophic', value: 5 },
                { name: 'Critical', value: 4 },
                { name: 'Moderate', value: 3 },
                { name: 'Marginal', value: 2 },
                { name: 'Negligible', value: 1 }
            ],
            
            cells: [
                // Frequent (5)
                [
                    { score: 25, category: 'CRITICAL' },
                    { score: 20, category: 'CRITICAL' },
                    { score: 15, category: 'HIGH' },
                    { score: 10, category: 'HIGH' },
                    { score: 5, category: 'MEDIUM' }
                ],
                // Probable (4)
                [
                    { score: 20, category: 'CRITICAL' },
                    { score: 16, category: 'HIGH' },
                    { score: 12, category: 'HIGH' },
                    { score: 8, category: 'MEDIUM' },
                    { score: 4, category: 'LOW' }
                ],
                // Occasional (3)
                [
                    { score: 15, category: 'HIGH' },
                    { score: 12, category: 'HIGH' },
                    { score: 9, category: 'MEDIUM' },
                    { score: 6, category: 'MEDIUM' },
                    { score: 3, category: 'LOW' }
                ],
                // Remote (2)
                [
                    { score: 10, category: 'HIGH' },
                    { score: 8, category: 'MEDIUM' },
                    { score: 6, category: 'MEDIUM' },
                    { score: 4, category: 'LOW' },
                    { score: 2, category: 'LOW' }
                ],
                // Improbable (1)
                [
                    { score: 5, category: 'MEDIUM' },
                    { score: 4, category: 'LOW' },
                    { score: 3, category: 'LOW' },
                    { score: 2, category: 'LOW' },
                    { score: 1, category: 'LOW' }
                ]
            ],
            
            // Map occurrence level (Low/Medium/High) to numeric value
            mapOccurrenceToLikelihood: (occurrence) => {
                if (!occurrence) return 3;
                const occ = occurrence.toString().toLowerCase();
                if (occ === 'high') return 5;
                if (occ === 'medium') return 3;
                if (occ === 'low') return 1;
                return 3;
            },
            
            getCellClass: (category) => {
                switch(category) {
                    case 'CRITICAL': return 'matrix-cell-critical';
                    case 'HIGH': return 'matrix-cell-high';
                    case 'MEDIUM': return 'matrix-cell-medium';
                    case 'LOW': return 'matrix-cell-low';
                    default: return '';
                }
            },
            
            getLikelihoodName: (value) => {
                const map = { 5: 'Frequent', 4: 'Probable', 3: 'Occasional', 2: 'Remote', 1: 'Improbable' };
                return map[value] || 'Unknown';
            },
            
            getSeverityName: (value) => {
                const map = { 5: 'Catastrophic', 4: 'Critical', 3: 'Moderate', 2: 'Marginal', 1: 'Negligible' };
                return map[value] || 'Unknown';
            },
            
            isAcceptable: (category) => {
                return !['CRITICAL', 'HIGH'].includes(category);
            }
        };

        // State
        let currentRiskData = null;
        let refreshInterval = null;
        let currentRiskId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== Risk Matrix Page Initialized ===');
            
            // Get risk ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentRiskId = urlParams.get('riskId');
            
            if (currentRiskId) {
                // Try API first
                fetchRiskDataFromAPI(currentRiskId);
            } else {
                // Fallback to localStorage
                loadFromLocalStorage();
            }
            
            // Set up auto-refresh every 30 seconds
            startAutoRefresh();
        });

        // Clean up
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // Extract likelihood and impact from your data structure
        function extractLikelihoodAndImpact(data) {
            let likelihood = 3; // default
            let likelihoodField = 'default';
            let impact = 4; // default
            let impactField = 'default';
            
            if (!data) return { likelihood, impact };
            
            console.log('Extracting from data:', data);
            
            // Check for occurenceLevel (your primary likelihood field)
            if (data.occurenceLevel) {
                likelihood = riskMatrix.mapOccurrenceToLikelihood(data.occurenceLevel);
                likelihoodField = 'occurenceLevel';
            }
            
            // Check for impact - try multiple fields
            if (data.impact && typeof data.impact === 'number') {
                impact = Math.min(5, Math.max(1, data.impact));
                impactField = 'impact';
            } else if (data.severity && typeof data.severity === 'number') {
                impact = Math.min(5, Math.max(1, data.severity));
                impactField = 'severity';
            } else if (data.projectRamCurrent) {
                // Use project RAM as proxy
                const ram = data.projectRamCurrent.toLowerCase();
                if (ram === 'high') impact = 5;
                else if (ram === 'medium') impact = 3;
                else if (ram === 'low') impact = 1;
                impactField = 'projectRamCurrent';
            }
            
            return { likelihood, impact };
        }

        // Fetch from API
        async function fetchRiskDataFromAPI(riskId) {
            try {
                const token = localStorage.getItem('token');
                
                document.getElementById('refreshBtn').classList.add('refreshing');
                
                const response = await fetch(`${API_BASE_URL}/analyst/risks/${riskId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const riskData = await response.json();
                console.log('API risk data received:', riskData);
                
                updateMatrixWithData(riskData);
                
                localStorage.setItem('viewingRisk', JSON.stringify(riskData));
                
                document.getElementById('updateTime').textContent = 'Just now';
                document.getElementById('dataSourceBadge').innerHTML = '<i class="fas fa-cloud"></i> Live';
                document.getElementById('dataSourceBadge').className = 'data-source-badge api';
                
            } catch (error) {
                console.error('Error fetching from API:', error);
                loadFromLocalStorage();
                document.getElementById('dataSourceBadge').innerHTML = '<i class="fas fa-database"></i> Cached';
                document.getElementById('dataSourceBadge').className = 'data-source-badge cached';
            } finally {
                document.getElementById('refreshBtn').classList.remove('refreshing');
            }
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            const storedRisk = JSON.parse(localStorage.getItem('viewingRisk') || '{}');
            
            if (Object.keys(storedRisk).length > 0) {
                console.log('Loading from localStorage:', storedRisk);
                updateMatrixWithData(storedRisk);
                document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
                document.getElementById('dataSourceBadge').innerHTML = '<i class="fas fa-database"></i> Cached';
                document.getElementById('dataSourceBadge').className = 'data-source-badge cached';
            } else {
                loadSampleData();
            }
        }

        // Update matrix with risk data
        function updateMatrixWithData(riskData) {
            currentRiskData = riskData;
            
            const { likelihood, impact } = extractLikelihoodAndImpact(riskData);
            
            console.log('Using - Likelihood:', likelihood, 'Impact:', impact);
            
            // Update header
            document.getElementById('riskIdBadge').textContent = riskData.riskId || 'RISK-001';
            document.getElementById('riskId').textContent = `ID: ${riskData.riskId || 'RISK-001'}`;
            document.getElementById('riskTitle').textContent = riskData.title || 'Risk Assessment';
            document.getElementById('riskOwner').textContent = riskData.riskOwnerName || riskData.owner || '—';
            
            if (riskData.updatedAt) {
                const date = new Date(riskData.updatedAt);
                document.getElementById('lastReviewed').textContent = date.toLocaleDateString();
            }
            
            document.getElementById('functionalArea').textContent = riskData.functionalAreaTECOP || riskData.area || '—';
            
            populateMatrix(likelihood, impact);
            updateAssessment(likelihood, impact);
        }

        // Populate matrix
        function populateMatrix(likelihood, impact) {
            const matrixBody = document.getElementById('matrixBody');
            if (!matrixBody) return;
            
            const likelihoodIndex = 5 - likelihood;
            const impactIndex = 5 - impact;
            
            let matrixHtml = '';
            
            riskMatrix.likelihoodLevels.forEach((likelihoodLevel, rowIdx) => {
                matrixHtml += '<tr>';
                matrixHtml += `<td>${likelihoodLevel.name}</td>`;
                
                riskMatrix.severityLevels.forEach((severityLevel, colIdx) => {
                    const cell = riskMatrix.cells[rowIdx][colIdx];
                    const cellClass = riskMatrix.getCellClass(cell.category);
                    const isHighlighted = (rowIdx === likelihoodIndex && colIdx === impactIndex);
                    
                    matrixHtml += `<td class="${cellClass} ${isHighlighted ? 'matrix-cell-highlight' : ''}">
                                    ${cell.score}
                                  </td>`;
                });
                
                matrixHtml += '</tr>';
            });
            
            matrixBody.innerHTML = matrixHtml;
        }

        // Update assessment
        function updateAssessment(likelihood, impact) {
            const score = likelihood * impact;
            
            let category = 'LOW';
            if (score >= 15) category = 'CRITICAL';
            else if (score >= 10) category = 'HIGH';
            else if (score >= 5) category = 'MEDIUM';
            
            const isAcceptable = riskMatrix.isAcceptable(category);
            
            document.getElementById('likelihoodValue').textContent = riskMatrix.getLikelihoodName(likelihood);
            document.getElementById('likelihoodDesc').textContent = `Level ${likelihood}`;
            document.getElementById('impactValue').textContent = riskMatrix.getSeverityName(impact);
            document.getElementById('impactDesc').textContent = `Level ${impact}`;
            
            document.getElementById('likelihoodNum').textContent = likelihood;
            document.getElementById('impactNum').textContent = impact;
            document.getElementById('scoreCalculation').textContent = score;
            
            document.getElementById('currentScore').textContent = score;
            const categoryElement = document.getElementById('currentCategory');
            categoryElement.textContent = category;
            categoryElement.className = `rating-category category-${category.toLowerCase()}`;
            
            const acceptabilityBadge = document.getElementById('acceptabilityBadge');
            const acceptabilityBadgeLarge = document.getElementById('acceptabilityBadgeLarge');
            
            if (isAcceptable) {
                acceptabilityBadge.innerHTML = '<span class="badge-acceptable">✓ Acceptable</span>';
                acceptabilityBadgeLarge.innerHTML = '<i class="fas fa-check-circle"></i> Acceptable';
                acceptabilityBadgeLarge.className = 'assessment-badge badge-acceptable';
            } else {
                acceptabilityBadge.innerHTML = '<span class="badge-unacceptable">✗ Unacceptable</span>';
                acceptabilityBadgeLarge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Unacceptable';
                acceptabilityBadgeLarge.className = 'assessment-badge badge-unacceptable';
            }
        }

        // Load sample data
        function loadSampleData() {
            const sampleData = {
                riskId: 'RISK-001',
                title: 'Cyber Security Breach',
                riskOwnerName: 'Alex Chen',
                functionalAreaTECOP: 'IT',
                updatedAt: new Date().toISOString(),
                occurenceLevel: 'High',
                impact: 4
            };
            
            updateMatrixWithData(sampleData);
            document.getElementById('dataSourceBadge').innerHTML = '<i class="fas fa-database"></i> Sample';
            document.getElementById('dataSourceBadge').className = 'data-source-badge cached';
        }

        // Auto-refresh
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (currentRiskId) {
                    fetchRiskDataFromAPI(currentRiskId);
                }
            }, 30000);
        }

        // Manual refresh
        function refreshData() {
            if (currentRiskId) {
                fetchRiskDataFromAPI(currentRiskId);
            } else {
                loadFromLocalStorage();
            }
        }

        // Close window
        function closeWindow() {
            window.close();
        }

        // Print matrix
        function printMatrix() {
            window.print();
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <div>${message}</div>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        // Make functions global
        window.refreshData = refreshData;
        window.closeWindow = closeWindow;
        window.printMatrix = printMatrix;
    </script>
</body>
</html>